<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5">

<head>
    <meta charset="UTF-8">
    <title>My profile | TripToday</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" th:href="@{/css/main.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/css/header.css}"/>
    <link rel="stylesheet" type="text/css" th:href="@{/css/profile-page.css}"/>
    <link rel="stylesheet" type="text/css" th:href="@{/css/upcoming-trips-page.css}" />
    <script src="http://localhost:35729/livereload.js"></script>
</head>
<body>

<div th:replace="~{/fragments/header :: header}"></div>

<div class="profile-container container">

    <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
        <p th:text="${successMessage}"></p>
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <p th:text="${errorMessage}"></p>
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>

    <div class="profile-info-card">
        <div th:if="${user != null}">
            <img class="profile-avatar" width="150" height="150" th:src="${user.picture ?: 'default_picture_url.jpg'}" alt="Profile Picture"/>
            <p class="text-center"><strong>Email:</strong> <span th:text="${user.email}"></span></p>
            <p class="text-center">
                <strong>Account role(s):</strong>
                <span th:text="${user.role}"></span>
            </p>
        </div>
        <div th:unless="${user != null}">
            <p class="text-danger">User details not available.</p>
        </div>


        <div th:if="${user != null and #lists.contains(user.role?.split(' \| ') ?: T(java.util.Collections).emptyList(), 'Guide')}" class="description-container">
            <form th:action="@{/profile/update-description}" method="post">
                <div class="form-group">
                    <label for="description"><strong>Your description (as a guide):</strong></label>
                    <textarea id="description" name="description" class="form-control" th:text="${description}" placeholder="Enter your description..." maxlength="200"></textarea>
                    <div id="description-char-count" class="char-counter text-right text-muted small">0/200</div>
                </div>
                <button type="submit" class="btn btn-primary">Save Description</button>
            </form>
        </div>

        <div th:if="${user != null and #strings.startsWith(user.user_id, 'auth0')}" class="picture-update-container">
            <form th:action="@{/profile/update-picture}" method="post">
                <div class="form-group">
                    <label for="image-url-input"><strong>Update profile picture:</strong></label>
                    <input id="image-url-input" name="imageUrl" type="url" class="form-control" placeholder="Enter URL of picture here (e.g., https://...)" required>
                </div>
                <button type="submit" class="btn btn-secondary">Update picture</button>
            </form>
        </div>
    </div>

    <div class="trips-section">

        <div class="trip-toggle-buttons">
            <button id="show-upcoming-btn" class="btn btn-outline-primary active">Upcoming Trips</button>
            <button id="show-past-btn" class="btn btn-outline-primary">Past Trips</button>
        </div>

        <div id="upcoming-trips-content">
            <h4>Upcoming Trips</h4>
            <div th:if="${#lists.isEmpty(pageUpcomingTrips) and upcomingPage == 0}">
                <p>No upcoming trips found.</p>
            </div>
            <div th:each="trip, iterStat : ${pageUpcomingTrips}" class="trip-card">
                <div class="trip-column-image">
                    <img th:src="@{${trip.picture}}" alt="Trip Image"/>
                    <p th:text="${trip.destination}"></p>
                </div>
                <div class="trip-details-wrapper">
                    <p th:if="${trip.canceled}" class="text-danger font-weight-bold mb-2">This trip was canceled. The enrolling fee was transferred back to you.</p>
                    <div class="trip-info-grid">
                        <div class="trip-wrapper-details-item">
                            <h1>Departure location</h1>
                            <p th:text="${trip.departureLocation}"></p>
                        </div>
                        <div class="trip-wrapper-details-item">
                            <h1>Departure date</h1>
                            <p th:text="${#temporals.format(trip.departureDate, 'dd-MM-yyyy')}"></p>
                        </div>
                        <div class="trip-wrapper-details-item">
                            <h1>Departure hour</h1>
                            <p th:text="${trip.departureHour + ' UTC'}"></p>
                        </div>
                        <div class="trip-wrapper-details-item">
                            <h1>Return date</h1>
                            <p th:text="${#temporals.format(trip.returnDate, 'dd-MM-yyyy')}"></p>
                        </div>
                        <div class="trip-wrapper-details-item">
                            <h1>Duration</h1>
                            <p th:text="${trip.durationDays + ' days'}"></p>
                        </div>
                        <div class="trip-wrapper-details-item">
                            <h1>Available Spots</h1>
                            <p th:text="${trip.availableSpots + ' spots'}"></p>
                        </div>
                        <div class="trip-wrapper-details-item">
                            <h1>Enrollment fee</h1>
                            <p th:text="${trip.registrationFee + ' RON'}"></p>
                        </div>
                        <div class="trip-wrapper-details-item">
                            <h1>Hotel</h1>
                            <p th:text="${trip.hotelName ?: 'Not specified'}"></p>
                        </div>
                        <div class="trip-wrapper-details-item trip-guide-item">
                            <h1>Guide</h1>
                            <p>
                                <span th:if="${user != null and trip.guideId == user.user_id}" class="font-weight-bold">You are the guide</span>
                                <span th:unless="${user != null and trip.guideId == user.user_id}"
                                      th:text="${!#lists.isEmpty(upcomingTripGuideEmailsOnPage) and iterStat.index < #lists.size(upcomingTripGuideEmailsOnPage) ? upcomingTripGuideEmailsOnPage[iterStat.index] : 'N/A'}">
                                </span>
                            </p>
                        </div>
                    </div>
                    <div class="trip-wrapper-description" th:if="${trip.description != null and !trip.description.isEmpty()}">
                        <p th:text="${trip.description}"></p>
                    </div>
                </div>
            </div>
            <div class="pagination" th:if="${totalUpcomingPages > 1}">
                <a th:if="${upcomingPage > 0}" th:href="@{'/profile'(up_page=${upcomingPage - 1}, pa_page=${pastPage})}">
                    <button>&#8592;</button>
                </a>
                <span th:each="i : ${#numbers.sequence(0, totalUpcomingPages - 1)}">
                    <a th:if="${i != upcomingPage}" th:href="@{'/profile'(up_page=${i}, pa_page=${pastPage})}">
                        <button th:text="${i + 1}"></button>
                    </a>
                    <span th:if="${i == upcomingPage}" class="current-page" th:text="${i + 1}"></span>
                </span>
                <a th:if="${upcomingPage + 1 < totalUpcomingPages}" th:href="@{'/profile'(up_page=${upcomingPage + 1}, pa_page=${pastPage})}">
                    <button>&#8594;</button>
                </a>
            </div>
        </div>

        <div id="past-trips-content" style="display: none;">
            <h4>Past Trips</h4>
            <div th:if="${#lists.isEmpty(pagePastTrips) and pastPage == 0}">
                <p>No past trips found.</p>
            </div>
            <div th:each="trip, iterStat : ${pagePastTrips}" class="trip-card">
                <div class="trip-column-image">
                    <img th:src="@{${trip.picture}}" alt="Trip Image"/>
                    <p th:text="${trip.destination}"></p>
                </div>
                <div class="trip-details-wrapper">
                    <p th:if="${trip.canceled}" class="text-danger font-weight-bold mb-2">This trip was canceled</p>
                    <div class="trip-info-grid">
                        <div class="trip-wrapper-details-item">
                            <h1>Departure location</h1>
                            <p th:text="${trip.departureLocation}"></p>
                        </div>
                        <div class="trip-wrapper-details-item">
                            <h1>Departure date</h1>
                            <p th:text="${#temporals.format(trip.departureDate, 'dd-MM-yyyy')}"></p>
                        </div>
                        <div class="trip-wrapper-details-item">
                            <h1>Departure hour</h1>
                            <p th:text="${trip.departureHour + ' UTC'}"></p>
                        </div>
                        <div class="trip-wrapper-details-item">
                            <h1>Return date</h1>
                            <p th:text="${#temporals.format(trip.returnDate, 'dd-MM-yyyy')}"></p>
                        </div>
                        <div class="trip-wrapper-details-item">
                            <h1>Duration</h1>
                            <p th:text="${trip.durationDays + ' days'}"></p>
                        </div>
                        <div class="trip-wrapper-details-item">
                            <h1>Remaining spots</h1>
                            <p th:text="${trip.availableSpots + ' spots'}"></p>
                        </div>
                        <div class="trip-wrapper-details-item">
                            <h1>Fee</h1>
                            <p th:text="${trip.registrationFee + ' RON'}"></p>
                        </div>
                        <div class="trip-wrapper-details-item">
                            <h1>Hotel</h1>
                            <p th:text="${trip.hotelName ?: 'Not specified'}"></p>
                        </div>
                        <div class="trip-wrapper-details-item trip-guide-item">
                            <h1>Guide</h1>
                            <p>
                                <span th:if="${user != null and trip.guideId == user.user_id}" class="font-weight-bold">You were the guide</span>
                                <span th:unless="${user != null and trip.guideId == user.user_id}"
                                      th:text="${!#lists.isEmpty(pastTripGuideEmailsOnPage) and iterStat.index < #lists.size(pastTripGuideEmailsOnPage) ? pastTripGuideEmailsOnPage[iterStat.index] : 'N/A'}">
                                 </span>
                            </p>
                        </div>
                    </div>
                    <div class="trip-wrapper-description" th:if="${trip.description != null and !trip.description.isEmpty()}">
                        <p th:text="${trip.description}"></p>
                    </div>
                </div>
            </div>
            <div class="pagination" th:if="${totalPastPages > 1}">
                <a th:if="${pastPage > 0}" th:href="@{'/profile'(up_page=${upcomingPage}, pa_page=${pastPage - 1})}">
                    <button>&#8592;</button>
                </a>
                <span th:each="i : ${#numbers.sequence(0, totalPastPages - 1)}">
                    <a th:if="${i != pastPage}" th:href="@{'/profile'(up_page=${upcomingPage}, pa_page=${i})}">
                        <button th:text="${i + 1}"></button>
                    </a>
                    <span th:if="${i == pastPage}" class="current-page" th:text="${i + 1}"></span>
                </span>
                <a th:if="${pastPage + 1 < totalPastPages}" th:href="@{'/profile'(up_page=${upcomingPage}, pa_page=${pastPage + 1})}">
                    <button>&#8594;</button>
                </a>
            </div>
        </div>
    </div>

</div>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js"></script>

<script>
    $(document).ready(function() {
        // Contor caractere descriere
        const descriptionTextarea = $('#description');
        const charCountDisplay = $('#description-char-count');
        if (descriptionTextarea.length > 0) {
            const maxLength = parseInt(descriptionTextarea.attr('maxlength'), 10);
            function updateCounter() {
                if (charCountDisplay.length > 0 && !isNaN(maxLength)) {
                    const currentLength = descriptionTextarea.val().length;
                    charCountDisplay.text(currentLength + '/' + maxLength);
                    if (currentLength > maxLength * 0.95) {
                        charCountDisplay.removeClass('text-danger').addClass('text-warning');
                    } else {
                        charCountDisplay.removeClass('text-danger text-warning');
                    }
                }
            }
            updateCounter();
            descriptionTextarea.on('input', updateCounter);
        }

        // Logica pentru butoanele de toggle excursii
        const upcomingBtn = $('#show-upcoming-btn');
        const pastBtn = $('#show-past-btn');
        const upcomingContent = $('#upcoming-trips-content');
        const pastContent = $('#past-trips-content');

        upcomingBtn.on('click', function() {
            if (!$(this).hasClass('active')) {
                pastContent.hide();
                upcomingContent.show();
                $(this).addClass('active');
                pastBtn.removeClass('active');
            }
        });

        pastBtn.on('click', function() {
            if (!$(this).hasClass('active')) {
                upcomingContent.hide();
                pastContent.show();
                $(this).addClass('active');
                upcomingBtn.removeClass('active');
            }
        });

    });
</script>

</body>
</html>