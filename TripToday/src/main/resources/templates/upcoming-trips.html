<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Trips</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css">
    <style>
        input[readonly] {
            background-color: #e9ecef; /* Culoare standard Bootstrap pentru readonly */
            cursor: not-allowed;
        }
        /* Stil popover (optional, Bootstrap are stiluri default) */
        .popover {
            max-width: 250px; /* Limiteaza latimea popover-ului */
        }
    </style>
</head>
<body>
<div th:replace="~{/fragments/header :: header}"></div>

<div class="container-fluid mt-4">
    <h1>Available Trips</h1>

    <div th:if="${user.get('role') == 'Manager' || user.get('role') == 'Manager | Guide' || user.get('role') == 'Manager | Guide | Traveler'}">
        <button class="btn btn-success mb-3" onclick="openAddTripModal()">Add New Trip</button>
    </div>

    <div th:if="${trips != null and not #lists.isEmpty(trips)}">
        <table class="table table-bordered table-striped">
            <thead>
            <tr>
                <th>Destination</th>
                <th>Departure Location</th>
                <th>Departure Date</th>
                <th>Departure Hour</th>
                <th>Return Date</th>
                <th>Duration (days)</th>
                <th>Available Spots</th>
                <th>Registration Fee</th>
                <th>Guide</th>
                <th>Description</th>
                <th>Hotel</th>
                <th>Picture</th>
                <th>Enroll</th>
                <th th:if="${user.get('role') == 'Manager' || user.get('role') == 'Manager | Guide' || user.get('role') == 'Manager | Guide | Traveler'}">Actions</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="trip : ${trips}">
                <td th:text="${trip.destination}"></td>
                <td th:text="${trip.departureLocation}"></td>
                <td th:text="${trip.departureDate}"></td>
                <td th:text="${trip.departureHour} + ' UTC'"></td>
                <td th:text="${trip.returnDate}"></td>
                <td th:text="${trip.durationDays}"></td>
                <td th:text="${trip.availableSpots}"></td>
                <td th:text="${trip.registrationFee + ' RON'}"></td>
                <td>
                    <span th:each="guide : ${guides}" th:if="${guide != null and guide['id'] == trip.guideId}" th:text="${guide['email']}"></span>
                    <span th:if="${trip.guideId == null}">No guide assigned</span>
                </td>
                <td th:text="${trip.description}"></td>
                <td th:text="${trip.hotelName}"></td>
                <td><img th:src="@{${trip.picture}}" width="150" height="150" alt="Trip Image"/></td>
                <td> <button type="button" class="btn btn-primary enroll-button"
                             th:attr="data-tripid=${trip.id},
                                     data-destination=${trip.destination},
                                     data-spots=${trip.availableSpots}">
                    Enroll
                </button>
                </td>
                <td th:if="${user.get('role') == 'Manager' || user.get('role') == 'Manager | Guide' || user.get('role') == 'Manager | Guide | Traveler'}">
                    <button class="btn btn-warning btn-sm" th:attr="data-tripid=${trip.id}" onclick="openEditTripModal(this)">Edit</button>
                    <button class="btn btn-danger btn-sm" th:attr="data-tripid=${trip.id}" onclick="openDeleteModal(this)">Delete</button>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <div th:if="${trips == null or #lists.isEmpty(trips)}">
        <p>No trips available at the moment.</p>
    </div>
</div>

<div class="modal fade" id="addTripModal" tabindex="-1" role="dialog" aria-labelledby="addTripModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <form id="addTripForm" method="post" th:action="@{/create-trip}" class="needs-validation" novalidate>
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addTripModalLabel">Add New Trip</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="addGuideSelect">Select Guide</label>
                        <select class="form-control" name="guideId" id="addGuideSelect" required>
                            <option value="" disabled selected>Select Guide</option>
                            <option th:each="guide : ${guides}"
                                    th:if="${guide != null}"
                                    th:value="${guide.id}"
                                    th:text="${guide.email}">
                            </option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="addDestination">Destination</label>
                        <input type="text" class="form-control" name="destination" id="addDestination" required>
                    </div>
                    <div class="form-group">
                        <label for="addDepartureLocation">Departure Location</label>
                        <input type="text" class="form-control" name="departureLocation" id="addDepartureLocation" required>
                    </div>
                    <div class="form-group">
                        <label for="addDepartureDate">Departure Date</label>
                        <input type="date" class="form-control" name="departureDate" id="addDepartureDate" required>
                    </div>
                    <div class="form-group">
                        <label for="addReturnDate">Return Date</label>
                        <input type="date" class="form-control" name="returnDate" id="addReturnDate" required>
                    </div>
                    <div class="form-group">
                        <label for="addDepartureHour">Departure Hour</label>
                        <input type="time" class="form-control" name="departureHour" id="addDepartureHour" required>
                    </div>
                    <div class="form-group">
                        <label for="addDurationDays">Duration (days)</label>
                        <input type="number" class="form-control" name="durationDays" id="addDurationDays" required min="1" readonly>
                    </div>
                    <div class="form-group">
                        <label for="addAvailableSpots">Available Spots</label>
                        <input type="number" class="form-control" name="availableSpots" id="addAvailableSpots" required min="0">
                    </div>
                    <div class="form-group">
                        <label for="addRegistrationFee">Registration Fee</label>
                        <input type="number" step="0.01" class="form-control" name="registrationFee" id="addRegistrationFee" required min="0">
                    </div>
                    <div class="form-group">
                        <label for="addHotelName">Hotel Name</label>
                        <input type="text" class="form-control" name="hotelName" id="addHotelName" required>
                    </div>
                    <div class="form-group">
                        <label for="addDescription">Description</label>
                        <textarea class="form-control" name="description" id="addDescription" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="addPicture">Picture URL</label>
                        <input type="url" class="form-control" name="picture" id="addPicture" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Save Trip</button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="enrollModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <form th:action="@{/enroll}" method="post" id="enrollForm" class="needs-validation" novalidate>
            <input type="hidden" name="tripId" id="modalTripId"/>
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Enrollment</h5>
                    <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to enroll in <strong id="modalDestination"></strong>?
                    <div class="form-group mt-3">
                        <label>Card Number</label>
                        <input type="text" class="form-control" name="cardNumber" required pattern="\d{16}"
                               title="Please enter a 16-digit card number" maxlength="16">
                    </div>
                    <div class="form-group">
                        <label>CVV</label>
                        <input type="text" class="form-control" name="cvv" required pattern="\d{3}"
                               title="Please enter a 3-digit CVV" maxlength="3">
                    </div>
                    <div class="form-group">
                        <label>Expiration Date (MM/YY)</label>
                        <input type="text" class="form-control" name="expirationDate" required
                               pattern="(0[1-9]|1[0-2])\/\d{2}"
                               title="Use MM/YY format. Date cannot be in the past." maxlength="5"> </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Yes, Enroll</button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="editTripModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <form id="editTripForm" method="post" th:action="@{/update-trip}" class="needs-validation" novalidate>
            <input type="hidden" name="id" id="editTripId">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Trip</h5>
                    <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="editGuideSelect">Select Guide</label>
                        <select class="form-control" name="guideId" id="editGuideSelect" required>
                            <option value="" disabled>Select Guide</option>
                            <option th:each="guide : ${guides}"
                                    th:if="${guide != null}"
                                    th:value="${guide.id}"
                                    th:text="${guide.email}">
                            </option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editDestination">Destination</label>
                        <input type="text" class="form-control" name="destination" id="editDestination" required>
                    </div>
                    <div class="form-group">
                        <label for="editDepartureLocation">Departure Location</label>
                        <input type="text" class="form-control" name="departureLocation" id="editDepartureLocation" required>
                    </div>
                    <div class="form-group">
                        <label for="editDepartureDate">Departure Date</label>
                        <input type="date" class="form-control" name="departureDate" id="editDepartureDate" required>
                    </div>
                    <div class="form-group">
                        <label for="editReturnDate">Return Date</label>
                        <input type="date" class="form-control" name="returnDate" id="editReturnDate" required>
                    </div>
                    <div class="form-group">
                        <label for="editDepartureHour">Departure Hour</label>
                        <input type="time" class="form-control" name="departureHour" id="editDepartureHour" required>
                    </div>
                    <div class="form-group">
                        <label for="editDurationDays">Duration (days)</label>
                        <input type="number" class="form-control" name="durationDays" id="editDurationDays" required min="1" readonly>
                    </div>
                    <div class="form-group">
                        <label for="editAvailableSpots">Available Spots</label>
                        <input type="number" class="form-control" name="availableSpots" id="editAvailableSpots" required min="0">
                    </div>
                    <div class="form-group">
                        <label for="editRegistrationFee">Registration Fee</label>
                        <input type="number" step="0.01" class="form-control" name="registrationFee" id="editRegistrationFee" required min="0">
                    </div>
                    <div class="form-group">
                        <label for="editHotelName">Hotel Name</label>
                        <input type="text" class="form-control" name="hotelName" id="editHotelName" required>
                    </div>
                    <div class="form-group">
                        <label for="editDescription">Description</label>
                        <textarea class="form-control" name="description" id="editDescription" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="editPicture">Picture URL</label>
                        <input type="url" class="form-control" name="picture" id="editPicture" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Trip</button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="deleteTripModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <form id="deleteTripForm" method="post" th:action="@{/delete-trip}">
            <input type="hidden" name="id" id="deleteTripId">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this trip?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Delete</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js"></script>

<script>
    // Functie PENTRU calcul durata si validare date
    function calculateAndUpdateDuration(departureDateInput, returnDateInput, durationInput) {
        const departureDateStr = $(departureDateInput).val();
        const returnDateStr = $(returnDateInput).val();
        const durationField = $(durationInput);
        const departureDateElem = $(departureDateInput)[0];
        const returnDateElem = $(returnDateInput)[0];

        durationField.removeClass('is-invalid is-valid');
        $(returnDateInput).removeClass('is-invalid is-valid');
        $(departureDateInput).removeClass('is-invalid is-valid');

        let isDepartureIndividuallyValid = departureDateElem.checkValidity();
        let isReturnIndividuallyValid = returnDateElem.checkValidity();

        if (!departureDateStr || !isDepartureIndividuallyValid) {
            $(departureDateInput).addClass('is-invalid');
            isDepartureIndividuallyValid = false;
        } else {
            $(departureDateInput).addClass('is-valid');
        }
        if (!returnDateStr || !isReturnIndividuallyValid) {
            $(returnDateInput).addClass('is-invalid');
            isReturnIndividuallyValid = false;
        } else {
            $(returnDateInput).addClass('is-valid');
        }

        if (isDepartureIndividuallyValid && isReturnIndividuallyValid && departureDateStr && returnDateStr) {
            const departureDate = new Date(departureDateStr);
            const returnDate = new Date(returnDateStr);

            if (returnDate >= departureDate) {
                const timeDiff = returnDate.getTime() - departureDate.getTime();
                const durationDays = Math.ceil(timeDiff / (1000 * 60 * 60 * 24)) + 1;
                durationField.val(durationDays >= 1 ? durationDays : 1).addClass('is-valid');
            } else {
                durationField.val('').addClass('is-invalid');
                $(returnDateInput).removeClass('is-valid').addClass('is-invalid');
                $(departureDateInput).removeClass('is-valid').addClass('is-invalid');
            }
        } else {
            durationField.val('').addClass('is-invalid');
        }
    }

    // Functie validare camp individual (on blur) - Actualizata pentru data expirare
    function validateFormField(fieldElement) {
        const field = $(fieldElement);
        field.removeClass('is-valid is-invalid'); // Sterge starea anterioara

        let isValid = fieldElement.checkValidity(); // Verifica constrangerile HTML5 (required, pattern etc.)

        // Verifica specific formatul SI data de expirare DACA validitatea de baza e ok
        if (field.attr('name') === 'expirationDate' && isValid) {
            const datePattern = /^(0[1-9]|1[0-2])\/(\d{2})$/; // Pattern MM/YY
            const match = field.val().match(datePattern);

            if (!match) {
                // Formatul nu este MM/YY conform patternului
                isValid = false;
            } else {
                // Formatul este corect, acum verificam daca data e in trecut
                const expiryMonth = parseInt(match[1], 10); // Luna (1-12)
                const expiryYearSuffix = parseInt(match[2], 10); // Sufix an (ex: 25)
                const expiryYear = 2000 + expiryYearSuffix; // Anul (ex: 2025)

                const today = new Date();
                const currentYear = today.getFullYear();
                const currentMonth = today.getMonth() + 1; // getMonth() e 0-11, adunam 1

                // Verificarea efectiva: An expirat < An curent SAU (An expirat == An curent SI Luna expirata < Luna curenta)
                if (expiryYear < currentYear || (expiryYear === currentYear && expiryMonth < currentMonth)) {
                    console.log(`Validation failed: Expiry date ${expiryMonth}/${expiryYear} is in the past relative to ${currentMonth}/${currentYear}.`);
                    isValid = false; // Data a expirat
                } else {
                    // Data este valida (curenta sau viitoare)
                    console.log(`Validation OK: Expiry date ${expiryMonth}/${expiryYear} is valid relative to ${currentMonth}/${currentYear}.`);
                }
            }
        }

        // Aplica clasa corespunzatoare bazata pe validitatea finala
        if (isValid) {
            field.addClass('is-valid');
        } else {
            field.addClass('is-invalid');
        }
    }

    // Functie validare formular complet
    function validateForm(formElement) {
        const form = $(formElement);
        let isFormValid = true;
        form.find('input, select, textarea').filter('[required]').each(function() {
            if (this.id !== 'addDurationDays' && this.id !== 'editDurationDays') {
                validateFormField(this); // Reutilizam functia de validare individuala
                if ($(this).hasClass('is-invalid')) isFormValid = false;
            }
        });
        if (form.attr('id') === 'addTripForm' || form.attr('id') === 'editTripForm') {
            const departureInputId = form.attr('id') === 'addTripForm' ? '#addDepartureDate' : '#editDepartureDate';
            const returnInputId = form.attr('id') === 'addTripForm' ? '#addReturnDate' : '#editReturnDate';
            const durationInputId = form.attr('id') === 'addTripForm' ? '#addDurationDays' : '#editDurationDays';
            calculateAndUpdateDuration(departureInputId, returnInputId, durationInputId);
            if (form.find(departureInputId).hasClass('is-invalid') || form.find(returnInputId).hasClass('is-invalid') || form.find(durationInputId).hasClass('is-invalid')) {
                isFormValid = false;
            }
        }
        return isFormValid;
    }

    // Functie curatare validare formular
    function clearFormValidation(formElement) {
        const form = $(formElement);
        form.removeClass('was-validated');
        form.find('.is-valid, .is-invalid').removeClass('is-valid is-invalid');
    }

    // Deschidere modal ADAUGARE
    function openAddTripModal() {
        const form = $('#addTripForm');
        form[0].reset();
        clearFormValidation(form);
        $('#addDurationDays').val('');
        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(today.getDate() + 1);
        const tomorrowString = tomorrow.toISOString().split('T')[0];
        $('#addDepartureDate').attr('min', tomorrowString);
        $('#addReturnDate').attr('min', tomorrowString);
        $('#addTripModal').modal('show');
    }

    // Functie pentru deschiderea modalului EDITARE excursie
    function openEditTripModal(button) {
        const form = $('#editTripForm');
        clearFormValidation(form);

        const tripId = $(button).data('tripid');
        const row = $(button).closest('tr');

        const destination = row.find('td:eq(0)').text().trim();
        const departureLocation = row.find('td:eq(1)').text().trim();
        const departureDate = row.find('td:eq(2)').text().trim();
        const departureHourRaw = row.find('td:eq(3)').text().trim();
        const departureHour = departureHourRaw.replace(' UTC', '').trim();
        const returnDate = row.find('td:eq(4)').text().trim();
        const availableSpots = row.find('td:eq(6)').text().trim();
        const registrationFeeRaw = row.find('td:eq(7)').text().trim();
        const registrationFee = registrationFeeRaw.replace(' RON', '').trim();
        let guideEmail = row.find('td:eq(8) span:first').text().trim();
        let initialGuideId = '';
        $('#editGuideSelect option').each(function() {
            if ($(this).text().trim() === guideEmail && guideEmail !== 'No guide assigned') {
                initialGuideId = $(this).val();
            }
        });

        const description = row.find('td:eq(9)').text().trim();
        const hotelName = row.find('td:eq(10)').text().trim();
        const pictureUrl = row.find('td:eq(11) img').attr('src');

        $('#editTripId').val(tripId);
        $('#editDestination').val(destination);
        $('#editDepartureLocation').val(departureLocation);
        $('#editDepartureDate').val(departureDate);
        $('#editDepartureHour').val(departureHour);
        $('#editReturnDate').val(returnDate);
        $('#editAvailableSpots').val(availableSpots);
        $('#editRegistrationFee').val(registrationFee);
        $('#editDescription').val(description);
        $('#editHotelName').val(hotelName);
        $('#editPicture').val(pictureUrl);
        $('#editGuideSelect').val(initialGuideId || '');

        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(today.getDate() + 1);
        const tomorrowString = tomorrow.toISOString().split('T')[0];
        $('#editDepartureDate').attr('min', tomorrowString);
        if (departureDate >= tomorrowString) {
            $('#editReturnDate').attr('min', departureDate);
        } else {
            $('#editReturnDate').attr('min', tomorrowString);
        }

        if (departureDate && returnDate) {
            calculateAndUpdateDuration('#editDepartureDate', '#editReturnDate', '#editDurationDays');
        } else {
            $('#editDurationDays').val('').removeClass('is-valid is-invalid');
        }
        validateForm('#editTripForm');
        form.addClass('was-validated');

        $('#editTripModal').modal('show');
    }

    // Deschidere modal STERGE
    function openDeleteModal(button) {
        const tripId = $(button).data('tripid');
        $('#deleteTripId').val(tripId);
        $('#deleteTripModal').modal('show');
    }

    // --- Event Listeners ---

    // Validare la blur pt AddTrip
    $('#addTripForm').find('input[required], select[required], textarea[required]').on('blur', function() {
        if (this.id !== 'addDurationDays') validateFormField(this);
        if (this.id === 'addDepartureDate' || this.id === 'addReturnDate') {
            const departureDateVal = $('#addDepartureDate').val();
            if (this.id === 'addDepartureDate' && departureDateVal && this.checkValidity()) $('#addReturnDate').attr('min', departureDateVal);
            calculateAndUpdateDuration('#addDepartureDate', '#addReturnDate', '#addDurationDays');
            const otherDateFieldId = (this.id === 'addDepartureDate') ? '#addReturnDate' : '#addDepartureDate';
            if ($(otherDateFieldId).val()) validateFormField($(otherDateFieldId)[0]);
        }
    });

    // Validare la blur pt EditTrip
    $('#editTripForm').find('input[required], select[required], textarea[required]').on('blur', function() {
        if (this.id !== 'editDurationDays') validateFormField(this);
        if (this.id === 'editDepartureDate' || this.id === 'editReturnDate') {
            const departureDateVal = $('#editDepartureDate').val();
            if (this.id === 'editDepartureDate' && departureDateVal && this.checkValidity()) $('#editReturnDate').attr('min', departureDateVal);
            calculateAndUpdateDuration('#editDepartureDate', '#editReturnDate', '#editDurationDays');
            const otherDateFieldId = (this.id === 'editDepartureDate') ? '#editReturnDate' : '#editDepartureDate';
            if ($(otherDateFieldId).val()) validateFormField($(otherDateFieldId)[0]);
        }
    });

    // Validare la blur pt Enroll (Acum valideaza si data expirare)
    $('#enrollForm').find('input[required]').on('blur', function() { validateFormField(this); });

    // Formatare data expirare card
    $('#enrollForm input[name="expirationDate"]').on('input', function(e) {
        var input = $(this), value = input.val(), digits = value.replace(/\D/g, ''), formattedValue = digits;
        if (digits.length >= 2) formattedValue = digits.substring(0, 2) + '/' + digits.substring(2, 4);
        input.val(formattedValue);
    });

    // Recalculare durata la schimbare date AddTrip
    $('#addDepartureDate, #addReturnDate').on('input change', function() {
        const departureDateVal = $('#addDepartureDate').val();
        if (this.id === 'addDepartureDate' && departureDateVal && this.checkValidity()) $('#addReturnDate').attr('min', departureDateVal);
        calculateAndUpdateDuration('#addDepartureDate', '#addReturnDate', '#addDurationDays');
    });

    // Recalculare durata la schimbare date EditTrip
    $('#editDepartureDate, #editReturnDate').on('input change', function() {
        const departureDateVal = $('#editDepartureDate').val();
        if (this.id === 'editDepartureDate' && departureDateVal && this.checkValidity()) $('#editReturnDate').attr('min', departureDateVal);
        calculateAndUpdateDuration('#editDepartureDate', '#editReturnDate', '#editDurationDays');
    });

    // --- Inițializare Popover și Handler pentru click pe butonul Enroll ---
    $(document).ready(function() {

        // Initializare Popovers pentru butoanele fara locuri
        $('.enroll-button').each(function() {
            const button = $(this);
            const spots = parseInt(button.data('spots'), 10);

            if (isNaN(spots) || spots <= 0) {
                button.popover({
                    content: 'Sorry, there are no available spots left.',
                    trigger: 'focus',
                    placement: 'top',
                    // container: 'body'
                });
            } else {
                if (button.data('bs.popover')) {
                    button.popover('dispose');
                }
            }
        });

        // Handler pentru click pe butonul Enroll
        $('.enroll-button').on('click', function(event) {
            const button = $(this);
            const spots = parseInt(button.data('spots'), 10);
            const tripId = button.data('tripid');
            const destination = button.data('destination');

            if (isNaN(spots) || spots <= 0) {
                console.log("Enroll clicked, spots <= 0. Popover should show via focus.");
                event.preventDefault();
            } else {
                console.log("Enroll clicked, spots > 0. Opening modal.");
                if (button.data('bs.popover')) {
                    button.popover('dispose');
                }
                const enrollModal = $('#enrollModal');
                const enrollForm = $('#enrollForm');
                clearFormValidation(enrollForm);
                enrollForm[0].reset();
                enrollModal.find('#modalTripId').val(tripId);
                enrollModal.find('#modalDestination').text(destination);
                enrollModal.modal('show');
            }
        });

        // Inchide popovers deschise daca se da click in afara lor
        $('body').on('click', function (e) {
            $('.enroll-button').each(function () {
                if (!$(this).is(e.target) && $(this).has(e.target).length === 0 && $('.popover').has(e.target).length === 0) {
                    if ($(this).data('bs.popover')) {
                        $(this).popover('hide');
                    }
                }
            });
        });

    }); // Sfarsit $(document).ready()

    // Handler vechi 'show.bs.modal' nu mai e necesar pt enrollModal
    /*
    $('#enrollModal').on('show.bs.modal', function (event) { ... });
    */

    // --- Handler general pentru Submit ---
    $('.needs-validation').submit(function(event) {
        const form = this;
        const isValid = validateForm(form); // Ruleaza validarea completa
        if (!isValid) {
            event.preventDefault();
            event.stopPropagation();
        }
        $(form).addClass('was-validated');
    });

</script>
</body>
</html>