<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Trips</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css">
    <style>
        input[readonly] {
            background-color: #e9ecef; /* Culoare standard Bootstrap pentru readonly */
            cursor: not-allowed;
        }
    </style>
</head>
<body>
<div th:replace="~{/fragments/header :: header}"></div>

<div class="container-fluid mt-4">
    <h1>Available Trips</h1>

    <div th:if="${user != null and (user.get('role') == 'Manager' or user.get('role') == 'Manager and guide')}">
        <button class="btn btn-success mb-3" onclick="openAddTripModal()">Add New Trip</button>
    </div>

    <div th:if="${trips != null and not #lists.isEmpty(trips)}">
        <table class="table table-bordered table-striped">
            <thead>
            <tr>
                <th>Trip ID</th>
                <th>Destination</th>
                <th>Departure Location</th>
                <th>Departure Date</th>
                <th>Departure Hour</th>
                <th>Return Date</th>
                <th>Duration (days)</th>
                <th>Available Spots</th>
                <th>Registration Fee</th>
                <th>Guide</th>
                <th>Description</th>
                <th>Hotel</th>
                <th>Picture</th>
                <th>Enroll</th>
                <th th:if="${user != null and (user.get('role') == 'Manager' or user.get('role') == 'Manager and guide')}">Actions</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="trip : ${trips}">
                <td th:text="${trip.id}"></td>
                <td th:text="${trip.destination}"></td>
                <td th:text="${trip.departureLocation}"></td>
                <td th:text="${trip.departureDate}"></td>
                <td th:text="${trip.departureHour}"></td>
                <td th:text="${trip.returnDate}"></td>
                <td th:text="${trip.durationDays}"></td>
                <td th:text="${trip.availableSpots}"></td>
                <td th:text="${trip.registrationFee}"></td>
                <td>
                    <span th:each="guide : ${guides}" th:if="${guide != null and guide['id'] == trip.guideId}" th:text="${guide['email']}"></span>
                    <span th:if="${trip.guideId == null}">No guide assigned</span>
                </td>
                <td th:text="${trip.description}"></td>
                <td th:text="${trip.hotelName}"></td>
                <td><img th:src="@{${trip.picture}}" width="150" height="150" alt="Trip Image"/></td>
                <td>
                    <button type="button" class="btn btn-primary"
                            data-toggle="modal"
                            data-target="#enrollModal"
                            th:attr="data-tripid=${trip.id}, data-destination=${trip.destination}">
                        Enroll
                    </button>
                </td>
                <td th:if="${user != null and (user.get('role') == 'Manager' or user.get('role') == 'Manager and guide')}">
                    <button class="btn btn-warning btn-sm" th:attr="data-tripid=${trip.id}" onclick="openEditTripModal(this)">Edit</button>
                    <button class="btn btn-danger btn-sm" th:attr="data-tripid=${trip.id}" onclick="openDeleteModal(this)">Delete</button>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <div th:if="${trips == null or #lists.isEmpty(trips)}">
        <p>No trips available at the moment.</p>
    </div>
</div>

<div class="modal fade" id="addTripModal" tabindex="-1" role="dialog" aria-labelledby="addTripModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <form id="addTripForm" method="post" th:action="@{/create-trip}" class="needs-validation" novalidate>
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addTripModalLabel">Add New Trip</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="addGuideSelect">Select Guide</label>
                        <select class="form-control" name="guideId" id="addGuideSelect" required>
                            <option value="" disabled selected>Select Guide</option>
                            <option th:each="guide : ${guides}"
                                    th:if="${guide != null}"
                                    th:value="${guide.id}"
                                    th:text="${guide.email}">
                            </option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="addDestination">Destination</label>
                        <input type="text" class="form-control" name="destination" id="addDestination" required>
                    </div>
                    <div class="form-group">
                        <label for="addDepartureLocation">Departure Location</label>
                        <input type="text" class="form-control" name="departureLocation" id="addDepartureLocation" required>
                    </div>
                    <div class="form-group">
                        <label for="addDepartureDate">Departure Date</label>
                        <input type="date" class="form-control" name="departureDate" id="addDepartureDate" required>
                    </div>
                    <div class="form-group">
                        <label for="addReturnDate">Return Date</label>
                        <input type="date" class="form-control" name="returnDate" id="addReturnDate" required>
                    </div>
                    <div class="form-group">
                        <label for="addDepartureHour">Departure Hour</label>
                        <input type="time" class="form-control" name="departureHour" id="addDepartureHour" required>
                    </div>
                    <div class="form-group">
                        <label for="addDurationDays">Duration (days)</label>
                        <input type="number" class="form-control" name="durationDays" id="addDurationDays" required min="1" readonly>
                    </div>
                    <div class="form-group">
                        <label for="addAvailableSpots">Available Spots</label>
                        <input type="number" class="form-control" name="availableSpots" id="addAvailableSpots" required min="0">
                    </div>
                    <div class="form-group">
                        <label for="addRegistrationFee">Registration Fee</label>
                        <input type="number" step="0.01" class="form-control" name="registrationFee" id="addRegistrationFee" required min="0">
                    </div>
                    <div class="form-group">
                        <label for="addHotelName">Hotel Name</label>
                        <input type="text" class="form-control" name="hotelName" id="addHotelName" required>
                    </div>
                    <div class="form-group">
                        <label for="addDescription">Description</label>
                        <textarea class="form-control" name="description" id="addDescription" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="addPicture">Picture URL</label>
                        <input type="url" class="form-control" name="picture" id="addPicture" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Save Trip</button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="enrollModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <form th:action="@{/enroll}" method="post" id="enrollForm" class="needs-validation" novalidate>
            <input type="hidden" name="tripId" id="modalTripId"/>
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Enrollment</h5>
                    <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to enroll in <strong id="modalDestination"></strong>?
                    <div class="form-group mt-3">
                        <label>Card Number</label>
                        <input type="text" class="form-control" name="cardNumber" required pattern="\d{16}"
                               title="Please enter a 16-digit card number" maxlength="16">
                    </div>
                    <div class="form-group">
                        <label>CVV</label>
                        <input type="text" class="form-control" name="cvv" required pattern="\d{3}"
                               title="Please enter a 3-digit CVV" maxlength="3">
                    </div>
                    <div class="form-group">
                        <label>Expiration Date (MM/YY)</label>
                        <input type="text" class="form-control" name="expirationDate" required
                               pattern="(0[1-9]|1[0-2])\/\d{2}" title="Please use MM/YY format" maxlength="5">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Yes, Enroll</button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="editTripModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <form id="editTripForm" method="post" th:action="@{/update-trip}" class="needs-validation" novalidate>
            <input type="hidden" name="id" id="editTripId">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Trip</h5>
                    <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="editGuideSelect">Select Guide</label>
                        <select class="form-control" name="guideId" id="editGuideSelect" required>
                            <option value="" disabled>Select Guide</option>
                            <option th:each="guide : ${guides}"
                                    th:if="${guide != null}"
                                    th:value="${guide.id}"
                                    th:text="${guide.email}">
                            </option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editDestination">Destination</label>
                        <input type="text" class="form-control" name="destination" id="editDestination" required>
                    </div>
                    <div class="form-group">
                        <label for="editDepartureLocation">Departure Location</label>
                        <input type="text" class="form-control" name="departureLocation" id="editDepartureLocation" required>
                    </div>
                    <div class="form-group">
                        <label for="editDepartureDate">Departure Date</label>
                        <input type="date" class="form-control" name="departureDate" id="editDepartureDate" required>
                    </div>
                    <div class="form-group">
                        <label for="editReturnDate">Return Date</label>
                        <input type="date" class="form-control" name="returnDate" id="editReturnDate" required>
                    </div>
                    <div class="form-group">
                        <label for="editDepartureHour">Departure Hour</label>
                        <input type="time" class="form-control" name="departureHour" id="editDepartureHour" required>
                    </div>
                    <div class="form-group">
                        <label for="editDurationDays">Duration (days)</label>
                        <input type="number" class="form-control" name="durationDays" id="editDurationDays" required min="1" readonly>
                    </div>
                    <div class="form-group">
                        <label for="editAvailableSpots">Available Spots</label>
                        <input type="number" class="form-control" name="availableSpots" id="editAvailableSpots" required min="0">
                    </div>
                    <div class="form-group">
                        <label for="editRegistrationFee">Registration Fee</label>
                        <input type="number" step="0.01" class="form-control" name="registrationFee" id="editRegistrationFee" required min="0">
                    </div>
                    <div class="form-group">
                        <label for="editHotelName">Hotel Name</label>
                        <input type="text" class="form-control" name="hotelName" id="editHotelName" required>
                    </div>
                    <div class="form-group">
                        <label for="editDescription">Description</label>
                        <textarea class="form-control" name="description" id="editDescription" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="editPicture">Picture URL</label>
                        <input type="url" class="form-control" name="picture" id="editPicture" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Trip</button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="deleteTripModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <form id="deleteTripForm" method="post" th:action="@{/delete-trip}">
            <input type="hidden" name="id" id="deleteTripId">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this trip?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Delete</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Functie pentru calcul durata si validare date
    function calculateAndUpdateDuration(departureDateInput, returnDateInput, durationInput) {
        const departureDateStr = $(departureDateInput).val();
        const returnDateStr = $(returnDateInput).val();
        const durationField = $(durationInput);

        durationField.removeClass('is-invalid is-valid');
        $(returnDateInput).removeClass('is-invalid is-valid');
        $(departureDateInput).removeClass('is-invalid is-valid');

        if (departureDateStr && returnDateStr) {
            const departureDate = new Date(departureDateStr);
            const returnDate = new Date(returnDateStr);

            if (returnDate >= departureDate) {
                const timeDiff = returnDate.getTime() - departureDate.getTime();
                const durationDays = Math.ceil(timeDiff / (1000 * 60 * 60 * 24)) + 1;

                if (durationDays >= 1) {
                    durationField.val(durationDays).addClass('is-valid');
                    $(returnDateInput).addClass('is-valid');
                    $(departureDateInput).addClass('is-valid');
                } else {
                    durationField.val(1).addClass('is-valid');
                    $(returnDateInput).addClass('is-valid');
                    $(departureDateInput).addClass('is-valid');
                }
            } else {
                durationField.val('').addClass('is-invalid');
                $(returnDateInput).addClass('is-invalid');
                if ($(departureDateInput)[0].checkValidity()) {
                    $(departureDateInput).addClass('is-valid');
                } else {
                    $(departureDateInput).addClass('is-invalid');
                }
            }
        } else {
            durationField.val('');
            if (!returnDateStr && $(returnDateInput).prop('required')) {
                $(returnDateInput).addClass('is-invalid');
            } else if (returnDateStr && $(returnDateInput)[0].checkValidity()) {
                $(returnDateInput).addClass('is-valid');
            } else if (returnDateStr) {
                $(returnDateInput).addClass('is-invalid');
            }

            if (!departureDateStr && $(departureDateInput).prop('required')) {
                $(departureDateInput).addClass('is-invalid');
            } else if (departureDateStr && $(departureDateInput)[0].checkValidity()) {
                $(departureDateInput).addClass('is-valid');
            } else if (departureDateStr) {
                $(departureDateInput).addClass('is-invalid');
            }
        }
    }

    // Functie curatare validare formular
    function clearFormValidation(formElement) {
        const form = $(formElement);
        form.removeClass('was-validated');
        form.find('.is-valid, .is-invalid').removeClass('is-valid is-invalid');
    }

    // Functie validare camp individual (on blur)
    function validateFormField(fieldElement) {
        const field = $(fieldElement);
        const form = field.closest('form');
        field.removeClass('is-valid is-invalid');

        let isValid = fieldElement.checkValidity();

        if (field.attr('id') === 'addReturnDate' || field.attr('id') === 'editReturnDate') {
            const departureInputId = field.attr('id') === 'addReturnDate' ? '#addDepartureDate' : '#editDepartureDate';
            const departureInput = form.find(departureInputId);
            if (isValid && field.val() && departureInput.val()) {
                const returnDate = new Date(field.val());
                const departureDate = new Date(departureInput.val());
                if (returnDate < departureDate) {
                    isValid = false;
                }
            }
        }
        // Specific check for expiration date format if basic validity passed
        if (field.attr('name') === 'expirationDate' && isValid) {
            if (!/^(0[1-9]|1[0-2])\/\d{2}$/.test(field.val())) {
                isValid = false;
            }
            // Optional: Add check for expiration date being in the past
            /*
            else {
                const parts = field.val().split('/');
                const month = parseInt(parts[0], 10);
                const year = parseInt('20' + parts[1], 10); // Assuming 21st century
                const now = new Date();
                const currentMonth = now.getMonth() + 1; // JS months are 0-11
                const currentYear = now.getFullYear();
                // Expired if year is past, or if year is current and month is past
                if (year < currentYear || (year === currentYear && month < currentMonth)) {
                    isValid = false;
                    // Consider adding a specific message or handling in validateForm if needed
                }
            }
            */
        }


        if (isValid) {
            field.addClass('is-valid');
        } else {
            field.addClass('is-invalid');
        }
    }

    // Functie validare formular complet (on submit / edit open)
    function validateForm(formElement) {
        const form = $(formElement);
        let isFormValid = true;

        form.find('input, select, textarea').filter('[required]').each(function() {
            validateFormField(this); // Ruleaza validarea individuala
            if ($(this).hasClass('is-invalid')) { // Verifica rezultatul
                isFormValid = false;
            }
        });

        const durationInput = form.find('input[name="durationDays"]');
        if (durationInput.length > 0) {
            const returnDateInputId = form.attr('id') === 'addTripForm' ? '#addReturnDate' : '#editReturnDate';
            const departureDateInputId = form.attr('id') === 'addTripForm' ? '#addDepartureDate' : '#editDepartureDate';
            if (form.find(returnDateInputId).hasClass('is-invalid') || form.find(departureDateInputId).hasClass('is-invalid')) {
                durationInput.removeClass('is-valid').addClass('is-invalid');
                isFormValid = false;
            } else {
                const durationValue = parseInt(durationInput.val(), 10);
                if (isNaN(durationValue) || durationValue < 1) {
                    durationInput.removeClass('is-valid').addClass('is-invalid');
                    isFormValid = false;
                } else {
                    durationInput.removeClass('is-invalid').addClass('is-valid');
                }
            }
        }
        return isFormValid;
    }

    // --- Functii deschidere modale ---

    function openAddTripModal() {
        const form = $('#addTripForm');
        form[0].reset();
        clearFormValidation(form);
        $('#addDurationDays').val('');
        $('#addTripModal').modal('show');
    }

    function openEditTripModal(button) {
        const form = $('#editTripForm');
        clearFormValidation(form);

        const row = $(button).closest('tr');
        const tripId = row.find('td:eq(0)').text().trim();
        const destination = row.find('td:eq(1)').text().trim();
        const departureLocation = row.find('td:eq(2)').text().trim();
        const departureDate = row.find('td:eq(3)').text().trim();
        const departureHour = row.find('td:eq(4)').text().trim();
        const returnDate = row.find('td:eq(5)').text().trim();
        const availableSpots = row.find('td:eq(7)').text().trim();
        const registrationFee = row.find('td:eq(8)').text().trim();
        const guideEmail = row.find('td:eq(9) span:first').text().trim();
        const description = row.find('td:eq(10)').text().trim();
        const hotelName = row.find('td:eq(11)').text().trim();
        const pictureUrl = row.find('td:eq(12) img').attr('src');

        $('#editTripId').val(tripId);
        $('#editDestination').val(destination);
        $('#editDepartureLocation').val(departureLocation);
        $('#editDepartureDate').val(departureDate);
        $('#editDepartureHour').val(departureHour);
        $('#editReturnDate').val(returnDate);
        $('#editAvailableSpots').val(availableSpots);
        $('#editRegistrationFee').val(registrationFee);
        $('#editDescription').val(description);
        $('#editHotelName').val(hotelName);
        $('#editPicture').val(pictureUrl);

        let guideFound = false;
        $('#editGuideSelect option').each(function () {
            if ($(this).text().trim() === guideEmail) {
                $(this).prop('selected', true);
                guideFound = true;
            } else {
                $(this).prop('selected', false);
            }
        });
        if (!guideFound) {
            $('#editGuideSelect option[value=""]').prop('selected', true);
        }

        calculateAndUpdateDuration('#editDepartureDate', '#editReturnDate', '#editDurationDays');
        validateForm('#editTripForm');
        $('#editTripForm').addClass('was-validated');

        $('#editTripModal').modal('show');
    }

    function openDeleteModal(button) {
        const tripId = $(button).data('tripid');
        $('#deleteTripId').val(tripId);
        $('#deleteTripModal').modal('show');
    }

    $('#enrollModal').on('show.bs.modal', function (event) {
        const form = $('#enrollForm');
        clearFormValidation(form);
        const button = $(event.relatedTarget);
        const tripId = button.data('tripid');
        const destination = button.data('destination');
        $('#modalTripId').val(tripId);
        $('#modalDestination').text(destination);
        form[0].reset();
        $('#modalTripId').val(tripId);
    });


    // --- Event Listeners pentru Validare Dinamica ---

    // Validare AddTrip fields on blur
    $('#addTripForm').find('input[required], select[required], textarea[required]').on('blur', function() {
        if (this.id !== 'addDurationDays') {
            validateFormField(this);
        }
        if (this.id === 'addDepartureDate' || this.id === 'addReturnDate') {
            calculateAndUpdateDuration('#addDepartureDate', '#addReturnDate', '#addDurationDays');
            const otherDateField = (this.id === 'addDepartureDate') ? '#addReturnDate' : '#addDepartureDate';
            // Trigger blur pe celalalt camp de data doar daca are o valoare, pt a re-valida dependenta
            if ($(otherDateField).val()) {
                $(otherDateField).trigger('blur');
            }
        }
    });

    // Validare Enroll fields on blur
    $('#enrollForm').find('input[required]').on('blur', function() {
        validateFormField(this);
    });

    // Formatter pentru Data Expirarii (MM/YY) - NOU
    $('#enrollForm input[name="expirationDate"]').on('input', function(e) {
        var input = $(this);
        var value = input.val();
        var cursor = this.selectionStart;
        var originalLength = value.length;

        // Pastreaza doar cifrele
        var digits = value.replace(/\D/g, '');

        // Formateaza MM/YY
        var formattedValue = digits;
        if (digits.length >= 2) {
            // Insereaza slash dupa primele 2 cifre
            formattedValue = digits.substring(0, 2) + '/' + digits.substring(2, 4);
        }

        // Aplica valoarea formatata (maxlength="5" in HTML limiteaza lungimea)
        input.val(formattedValue);

        // Recalculeaza pozitia cursorului
        // (Simplificare: muta cursorul la sfarsit dupa formatare automata)
        // O logica mai complexa ar fi necesara pentru a pastra pozitia exact in timpul editarii
        if (formattedValue.length > originalLength || (formattedValue.length === 3 && originalLength === 2)) {
            // Daca s-a adaugat slash-ul, muta cursorul dupa el
            this.setSelectionRange(formattedValue.length, formattedValue.length);
        } else {
            // Incearca sa mentina pozitia relativa (aproximativ)
            let currentDigitCount = formattedValue.replace(/\D/g, '').length;
            let oldDigitCount = value.substring(0, cursor).replace(/\D/g, '').length;
            let newCursorPos = oldDigitCount;
            if (oldDigitCount >= 2) newCursorPos++; // Adauga 1 pt slash
            newCursorPos = Math.min(newCursorPos, formattedValue.length);
            // Ajustare fina pentru stergere slash
            if (originalLength === 3 && formattedValue.length === 2 && cursor <= 2) {
                newCursorPos = cursor;
            } else if (originalLength > 3 && formattedValue.length < originalLength && cursor <=2) {
                newCursorPos = cursor;
            }
            this.setSelectionRange(newCursorPos, newCursorPos);
        }

    });


    // Recalculare durata la schimbare date in AddTrip
    $('#addDepartureDate, #addReturnDate').on('input change', function() {
        calculateAndUpdateDuration('#addDepartureDate', '#addReturnDate', '#addDurationDays');
    });

    // Recalculare durata si revalidare completa la schimbare date in EditTrip
    $('#editDepartureDate, #editReturnDate').on('input change', function() {
        calculateAndUpdateDuration('#editDepartureDate', '#editReturnDate', '#editDurationDays');
        validateForm('#editTripForm');
        $('#editTripForm').addClass('was-validated');
    });


    // --- Handler pentru Submit ---
    $('.needs-validation').submit(function(event) {
        const form = this;
        const isValid = validateForm(form);

        if (!isValid) {
            event.preventDefault();
            event.stopPropagation();
        }
        $(form).addClass('was-validated');
    });

</script>
</body>
</html>