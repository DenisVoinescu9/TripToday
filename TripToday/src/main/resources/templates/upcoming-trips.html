<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Trips</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css">
    <style>
        input[readonly] {
            background-color: #e9ecef;
            cursor: not-allowed;
        }
        .popover {
            max-width: 250px;
        }
    </style>
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>

<div class="container-fluid mt-4">

    <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
        <span th:text="${successMessage}"></span>
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>

    <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <span th:text="${errorMessage}"></span>
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>

    <h1>Available Trips</h1>

    <div th:if="${user != null and (user.get('role') == 'Manager' || user.get('role') == 'Manager | Guide' || user.get('role') == 'Manager | Guide | Traveler')}">
        <button class="btn btn-success mb-3" onclick="openAddTripModal()">Add New Trip</button>
    </div>

    <div th:if="${trips != null and not #lists.isEmpty(trips)}">
        <table class="table table-bordered table-striped">
            <thead>
            <tr>
                <th>Destination</th>
                <th>Departure Location</th>
                <th>Departure Date</th>
                <th>Departure Hour</th>
                <th>Return Date</th>
                <th>Duration (days)</th>
                <th>Available Spots</th>
                <th>Registration Fee</th>
                <th>Guide</th>
                <th>Description</th>
                <th>Hotel</th>
                <th>Picture</th>
                <th>Enroll</th>
                <th th:if="${user != null and (user.get('role') == 'Manager' || user.get('role') == 'Manager | Guide' || user.get('role') == 'Manager | Guide | Traveler')}">Actions</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="trip : ${trips}">
                <td th:text="${trip.destination}"></td>
                <td th:text="${trip.departureLocation}"></td>
                <td th:text="${trip.departureDate}"></td>
                <td th:text="${trip.departureHour} + ' UTC'"></td>
                <td th:text="${trip.returnDate}"></td>
                <td th:text="${trip.durationDays}"></td>
                <td th:text="${trip.availableSpots}"></td>
                <td th:text="${trip.registrationFee + ' RON'}"></td>
                <td>
                    <span th:each="guide : ${guides}" th:if="${guide != null and guide['id'] == trip.guideId}" th:text="${guide['email']}"></span>
                    <span th:if="${trip.guideId == null}">No guide assigned</span>
                </td>
                <td th:text="${trip.description}"></td>
                <td th:text="${trip.hotelName}"></td>
                <td><img th:src="@{${trip.picture}}" width="150" height="150" alt="Trip Image"/></td>
                <td>
                    <button type="button" class="btn btn-primary enroll-button"
                            th:attr="data-tripid=${trip.id},
                                     data-destination=${trip.destination},
                                     data-spots=${trip.availableSpots}">
                        Enroll
                    </button>
                </td>
                <td th:if="${user != null and (user.get('role') == 'Manager' || user.get('role') == 'Manager | Guide' || user.get('role') == 'Manager | Guide | Traveler')}">
                    <button class="btn btn-info btn-sm mr-1" th:attr="data-tripid=${trip.id}" onclick="openViewTravelersModal(this)">View Travelers</button>
                    <button class="btn btn-warning btn-sm mr-1" th:attr="data-tripid=${trip.id}" onclick="openEditTripModal(this)">Edit</button>
                    <button class="btn btn-danger btn-sm" th:attr="data-tripid=${trip.id}" onclick="openDeleteModal(this)">Delete</button>
                </td>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <div th:if="${trips == null or #lists.isEmpty(trips)}">
        <p>No trips available at the moment.</p>
    </div>
</div>
<div th:replace="~{fragments/tripModals :: viewTravelersModal}"></div>
<div th:replace="~{fragments/tripModals :: addTripModal}"></div>
<div th:replace="~{fragments/tripModals :: enrollModal}"></div>
<div th:replace="~{fragments/tripModals :: editTripModal}"></div>
<div th:replace="~{fragments/tripModals :: deleteTripModal}"></div>

<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js"></script>

<script th:src="@{/js/script.js}"></script>
</body>
</html>